import { Story } from '@storybook/addon-docs';

# Images

## Icons

There are 4 ways for you to use icons in Rocketship themes:
- use FontAwesome, as a font
- use a custom generated icon font
- use a custom generated SVG sprite: use classes or a generic mixin that displays the icons as background-images on a pseudo-element
- use a custom generated SVG sprite: use classes or a generic mixin that displays the icons as background-images on a pseudo-element

### FontAwesome

The easiest way to use icons. We use FontAwesome by default. <br />

- Make sure `$custom-icons` is set to `false` in `00-theme/00-base/00-config/00-variables/_vars-00-base.scss` <br />
- Refer to the mixins `under 00-theme/00-base/01-helpers/02-mixins/_mixins-typography.scss`<br />
- The icon names are the ones in use by FontAwesome, so you can refer to their online documentation to know what each icon is called

There are many examples in the themes of icons being used, just look for `@include font-awesome` for examples.

### Custom icons as font

**Requirements:**
- Icons must be svg
- Icons must be perfectly aligned: no decimals in px values for left and top !!!
- Artboard must be perfectly sized: no decimals in width and height !!!

**Instructions:**

Add your svg's to the `icons` folder of the theme

Use the Gulp command command line run `gulp icons:font` to generate the font<br />
The icons will be compiled into a font, located in `fonts/iconfont`

You will need to change the `$custom-icons` to `true` and `$custom-icons-type` to `font` in<br />
`00-theme/00-base/00-config/00-variables/_vars-base.scss`

As with other fonts, you will need to load the custom font in the html. <br />
Just the same as described in Base/Fonts documentation: <br />
- In your components-folder, look for `00-theme/05-pages/html/_html.twig` and add the iconfont name to `webfont_config_font_families` variable

There are mixins and classes to use this in `00-theme/00-base/01-helpers/02-mixins/_mixins-iconfont.scss`<br />

### Custom icons as sprite (2 ways)

Another option for using custom icons, is to use a sprite instead of a font.

**Requirements:**
- Icons must be svg
- Icons must be perfectly aligned: no decimals in px values for left and top !!!
- Artboard must be perfectly sized: no decimals in width and height !!!

Use the Gulp command `gulp icons:sprite`, which generates 2 sprites instead of a font: `images/generated/sprite-css.svg` and `sprite-inline.svg`<br />
Just like with the custom font, it will generate variables and mixins:

- `00-theme/00-base/01-helpers/02-mixins/_mixins-sprite.scss`
- `00-theme/00-base/09-icons/_icons-sprite.scss`

Now you have the option of using the classes & mixin that uses the icons via a background-image (see those 2 Sass files) or as an inline SVG.

A full list of the icons can be found in the Styleguide, in the 'Images' Atom, in 'Custom Icons' <br />
This is autogenerated using the icons in the `icons` folder (no nested folders please) and outputs the `icons.yml` file in the Styleguide folder.

**as background image**

This is very straightforward. Use the mixin (or the generated classes, if you can override elements in Twig). <br />

Example: set the 'test' icon by referencing the name of the icon and setting a size:
```
.rs-icon--test--b {
  @include sprite((icon: "rs-icon--test", size: 25));
}
```

**inline usage**

Using the sprite for inline elements in html, means adding your icons into Twig templates. <br />
refer to the SVG component in the Styleguide for an example: `/components/01-atoms/images/icons/_icon.twig`. <br />

Not all browsers can handle inline SVG and if you run into issues, you might have to include a polyfill to the theme libraries.<br />
There is one located here that you can load in a theme library if needed: `00-theme/01-atoms/04-images/icons/svgxuse.min.js` <br />

#### Examples of usage below:

Simple: pass the name of the original icon file (without the extention), a title and an array of extra classes (optional)

```
{{ icon('test', 'Test', ['rs-icon--xl whatever fubar']) }}
```

With a link around it:

```
<a href="#!" class="rs-icon-link">
  {{ icon('test', 'Test', ['rs-icon--xl whatever fubar']) }}
  A sample link with the {{icon_name}}-icon
</a>
```

The 'icon' function outputs something like this, where `use` refers to the generated SVG sprite that is loaded in `_page--master.twig`
```
<span class="wrapper--rs-icon">
  <svg class="rs-icon rs-icon--test" role="img" aria-hidden="true" title="Test" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use xlink:href="images/generated/sprite-inline.svg#rs-icon--test"></use>
  </svg>
</span>
```

Now if you want to change the color of your icon, this is possible simpy by setting the `color` property on your icon element (or a parent) via CSS.
This works because 1) color in CSS is inherited and 2) the generate SVG stroke & fill are set to `currentColor`. This enables overriding color via CSS.
```
.my-icon-selector {
  color: red;
}
```


## Responsive images

You will see during Drupal sitebuilding, that you can attach image styles to an image field, via its formatter.<br />
Usually, you will want to pick a 'responsive image style'. <br />
This is basically a collection of normal image styles but you tell it on what specific one to load per breakpoint. <br />

In Rocketship, there are already a lot of normal image styles (/admin/config/media/image-styles) available for you<br />
to compose your own responsive image styles (scaling but also cropping of all well-know ratios, like 3:2, 16:9, â€¦)<br />
And there are some responsive image styles(/admin/config/media/responsive-image-style) available as well <br />
(depending on what Rocketship Features and Paragraphs you installed).

Additionally, we have another formatter called `drimage`, which automatically generates responsive image styles for you, based on a preset ratio or scaling.
So you have less work setting things up. It is used in the 'image' Media Type view modes, which various Content Blocks use to display images.

In Storybook, the 'Responsive Image' and 'Blazy Responsive Image' show you what that would look like.<br />
The main difference with the actual Drupal output, is that the Storybook components use the `img` tag with a `srcset` attribute, <br />
while Drupal uses a `picture` tag with `source` tags inside of it per image style.<br />
We've chosen the simplified output in Storybook because visually the result is identical <br />
and there is already a high complexity to the Storybook image components. <br />
_(eg. already lots of nested templates and source_attributes don't render automatically)_


## Lazy loading

To optimize the loading of images in Rocketship, we have used several formatters and modules, however, these give inconsistent results when it comes to (lazy) loading images.
For example:
- Blazy tends to regularly break and only load the xs image
- drimage handles lazy loading very well but doesn't have a preloader

For this reason, we've added a custom solution that applies lazy loading on ALL images we could find, with a unified styling of the preloader.
So regular image styles, responsive images (using picture tag), blazy and drimage will show the same preloader (even if they don't all use the same system for lazy loading).

- Normally, Drupal Core 9.1+ will print the `loading` property as part of image attributes. If it doesn't, you can use `TEMPLATE_preprocess_HOOK` functions to force it. See the `image_preprocess` and `field_preprocess` hooks in the `.theme` file for existing examples.
- The twig files responsible for handling the `img` tag will print this attribute. Eg. `04-images/00-image/_image.twig` and any file that includes this template (like `_picture.twig`)
- **If you want to add lazy loading for browsers that don't support it natively** you HAVE to turn the fallback on in the theme settings in the admin pages: `/admin/appearance/settings/NAME_OF_YOUR_THEME`
  - this setting will replace `src` with `data-src` so the JS fallback can get to work.
  - this also means that on browsers with native support, loading goes a bit slower (because the JS does the detection + performs actions, instead of the browser handling it)
- `images.js` located in the `04-images/00-image` folder, contains the helper code. This will:
  - stop the preloader effect on img tags with `loading="lazy"` on them by adding a class `js-loaded` on its parent wrapper.
  - (optionally) fall back to non-native loading: checks images with the lazy loading attribute + `data-src` and load them when they become visible (using an observer)
- `_image.scss` located in that same folder, will apply styling on an `img` wrapper, that creates a preloader using pseudo-elements.
  - for Blazy: since it has its own formatter logic, and already has its own preloader, we override that specific styling without relying on our custom loading logic.
  - for drimage: we use the `.drimage` wrapper for applying the preloader styling

The `img`-tag gets a wrapper called `lazy-wrapper` (or we use the `.drimage` wrapper), which uses pseudo-elements to append an animated preloader.
When the image is done loading, the class `js-loaded` is added to the wrapper and the preloader disappears.
So the preloader is fully customizable via the theming layer, by either changing the styling (.scss) or changing the behavior (in .js).
Or as a last resort, by using preprocess hooks to change the relevant attribute(s).

Be aware that there is a chance the loaded image remains undetected, depending on inconsistent browser implementation or JS issues.
Which is why the preloader is small and has a negative index, so it disappears behind the loaded image if the class doesn't appear.
So keep your custom preloader small and unobtrusive, if you plan on customizing it.

For use in Storybook, take a look at the image yml files and you'll see a new attribute called `image_loading` that's responsible for printing the right props and classes.
Alternatively, you could add 'loading' to the image 'attributes' object. The first option is just a cleaner/more direct way to do it for components.

## Blazy

In Drupal we can choose to use this module to lazy load images, per image field, using the blazy formatter. <br />
Just like with a normal image field, you also need to pick an image style (or responsive image style)<br />
but the front-end will also output some extra classes and wrappers.<br />

We have faked this functionality within the Blazy Image and Blazy Responsive Image components so you can see the image preloader in action.<br />
The `blazy.load.js`-file simply uses a timeout to delay loading the image source, so you can see the preloader a little longer.<br />
To increase the delay or make other changes to help your theming, edit that javascript-file.

