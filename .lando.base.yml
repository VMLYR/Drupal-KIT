recipe: drupal10
excludes:
  - drush
  - node_modules
  - themesrc/node_modules
  - docroot/vendor
  - docroot/modules/contrib
config:
  php: '8.1'
  webroot: docroot
  composer_version: 2
services:
  appserver:
    xdebug: true
    config:
      php: .lando.php.ini
    overrides:
      environment:
        XDEBUG_MODE:
        LANDO_HOST_IP: "172.17.0.1"
        DRUPAL_TEST_DB_URL: mysql://user:user@database/user
        DRUPAL_TEST_WEBDRIVER_HOSTNAME: selenium
        DRUPAL_TEST_WEBDRIVER_PORT: 4444
        DRUPAL_TEST_CHROMEDRIVER_AUTOSTART: 'false'
        DRUPAL_TEST_WEBDRIVER_CHROME_ARGS:  '--no-sandbox --disable-dev-shm-usage --headless'
        DRUPAL_NIGHTWATCH_OUTPUT: ../sites/nightwatch
        DRUPAL_NIGHTWATCH_IGNORE_DIRECTORIES: node_modules,vendor,.*,sites/*/files,sites/*/private,sites/simpletest
        # PhpUnit vars.
        #SIMPLETEST_BASE_URL: https://d10lb-testing.lndo.site
        SIMPLETEST_BASE_URL: https://www.google.com
        SIMPLETEST_DB: mysql://user:user@database/www
        BROWSERTEST_OUTPUT_DIRECTORY: /app/sites/simpletest/browser_output
        MINK_DRIVER_ARGS_WEBDRIVER: '["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless", "--no-sandbox", "--disable-dev-shm-usage"]}}, "http://selenium:4444"]'
      extra_hosts:
        - ${LANDO_HOST_NAME_DEV:-host}:${LANDO_HOST_GATEWAY_DEV:-host-gateway}
    extras:
      #- apt-get update -y
      #- apt-get install rename -y
    build_as_root:
      - rm -rf /etc/apt/sources.list.d/nodesource.list && rm -rf /usr/local/bin/node* && rm -rf /usr/local/bin/npm*
      - curl -sL https://deb.nodesource.com/setup_16.x | bash -
      - cat /etc/apt/sources.list.d/nodesource.list
      - apt --fix-broken install
      - apt update && apt install -y nodejs
      - npm install --global yarn
    build:
      #- composer install
      - mkdir -p ${LANDO_WEBROOT}/sites/simpletest/browser_output
      - cd ${LANDO_WEBROOT}/core && yarn install
  database:
    creds:
      user: user
      password: user
      database: www
  node:
    type: node
    build:
      #- npm install
      #- npm install -G gulp
      #- cd /app/source && npm install
      #- cd /app/source && npm run gulp
  selenium:
    type: compose
    app_mount: false
    services:
      image: seleniarm/standalone-chromium:latest
      shm_size: 2gb
      command: /opt/bin/start-selenium-standalone.sh
tooling:
  nightwatch:
    service: appserver
    dir: /app/docroot/core
    cmd: yarn test:nightwatch
  yarn:
    service: appserver
    cmd: yarn
  node:
    service: node
  npm:
    service: node
    dir: /app/source
  gulp:
    service: node
    dir: /app/source
  xdebug-on:
    service: appserver
    description: Enable xdebug for Apache.
    cmd: docker-php-ext-enable xdebug && /etc/init.d/apache2 reload && echo "Enabling xdebug"
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for Apache.
    cmd: rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 reload && echo "Disabling xdebug"
    user: root
  kit/check-url:
    service: appserver
    description: Check response status on a list of URLs
    cmd: drush kit:check-url
  kit/conf:
    service: appserver
    description: Import/exprot environment specific configuration for a site
    cmd: drush kit:conf
  kit/gulp:
    service: node
    description: Run gulp tasks in the theme source directory.
    dir: /app/source
    cmd: npm run gulp
  kit/init:
    cmd:
      - appserver: composer install
      - node: npm install
      - node: npm install -G gulp
      - node: cd /app/source && npm install
      - node: cd /app/source && npm run gulp
  kit/sync:
    service: appserver
    description: Sync the local environemnt with most recent code, database and configuration.
    cmd: drush kit:sync
  kit/theme:
    description: Create a new theme
    cmd:
      - appserver: drush kit:theme
      - node: cd /app/source && npm install && npm run gulp
  grumphp:
    service: appserver
    cmd: php /app/vendor/bin/grumphp run
